{% extends 'offer/base.html' %}
{% load static %}
{% block title %}Редактировать{% endblock %}

{% block content %}

<main>
    <section class="edit">
        <div class="container">
            <!-- Блок сообщений -->
            <div id="messages-container">
                {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} fade-in">
                        {{ message }}
                        <span class="close-btn">×</span>
                    </div>
                    {% endfor %}
                {% endif %}
                
                <!-- Вывод ошибок формы -->
                {% if form.errors or material_formset.errors or dimension_formset.errors %}
                <div class="alert alert-error fade-in">
                    Пожалуйста, исправьте ошибки в форме.
                    <span class="close-btn">×</span>
                </div>
                {% endif %}
            </div>

            <a href="{% url 'product_list' %}" class="edit__back"><img src="{% static 'images/arrow-back.svg' %}">Назад</a>
            <h2 class="edit__title">Панель администратора</h2>
            <h2 class="edit__name"><span class="bold">{{ product.name|default:"Новый товар" }}</span></h2>

            <form method="post" enctype="multipart/form-data" id="product-form">
                {% csrf_token %}
                
                <!-- Основная информация -->
                <div class="edit__info">
                    <h2>Основная информация</h2>
                    
                    <div class="edit__wrapper">
                        <label>
                            Артикул
                            {{ form.article }}
                            {% for error in form.article.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                        <label>
                            Наименование
                            {{ form.name }}
                            {% for error in form.name.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                    </div>
                    
                    <div class="edit__wrapper">
                        <label>
                            Цена 
                            {{ form.price }}
                            {% for error in form.price.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                        <label>
                            Остаток 
                            {{ form.stock }}
                            {% for error in form.stock.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                    </div>
                    
                    <div class="edit__wrapper">
                        <label>
                            Цвет
                            {{ form.color }}
                            {% for error in form.color.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                        <label>
                            Категория
                            {{ form.category }}
                            {% for error in form.category.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                    </div>
                    
                    <div class="edit__wrapper">
                        <label>
                            Описание
                            {{ form.description }}
                            {% for error in form.description.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                    </div>
                    
                    <div class="edit__wrapper">
                        
                        <label class="edit__file">
                            Основное изображение <span class="required">*</span>
                            <div class="file-preview">
                                {% if form.instance.main_photo %}
                                    <img src="{{ form.instance.main_photo.url }}" width="50">
                                    <div class="file-info">
                                        <span class="file-name">{{ form.instance.main_photo.name|slice:"20:" }}</span>
                                        <span class="file-size">{{ form.instance.main_photo.size|filesizeformat }}</span>
                                    </div>
                                {% else %}
                                    <img src="{% static 'images/attachment.svg' %}">
                                    <div class="file-info">
                                        <p>Выбрать файл</p>
                                    </div>
                                {% endif %}
                            </div>
                            {{ form.main_photo }}
                            {% for error in form.main_photo.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                        
                        <label class="edit__file">
                            Доп. изображение 1 <span class="required">*</span>
                            <div class="file-preview">
                                {% if form.instance.additional_photo1 %}
                                    <img src="{{ form.instance.additional_photo1.url }}" width="50">
                                    <div class="file-info">
                                        <span class="file-name">{{ form.instance.additional_photo1.name|slice:"20:" }}</span>
                                        <span class="file-size">{{ form.instance.additional_photo1.size|filesizeformat }}</span>
                                    </div>
                                {% else %}
                                    <img src="{% static 'images/attachment.svg' %}">
                                    <div class="file-info">
                                        <p>Выбрать файл</p>
                                    </div>
                                {% endif %}
                            </div>
                            {{ form.additional_photo1 }}
                            {% for error in form.additional_photo1.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                        
                        <label class="edit__file">
                            Доп. изображение 2 <span class="required">*</span>
                            <div class="file-preview">
                                {% if form.instance.additional_photo2 %}
                                    <img src="{{ form.instance.additional_photo2.url }}" width="50">
                                    <div class="file-info">
                                        <span class="file-name">{{ form.instance.additional_photo2.name|slice:"20:" }}</span>
                                        <span class="file-size">{{ form.instance.additional_photo2.size|filesizeformat }}</span>
                                    </div>
                                {% else %}
                                    <img src="{% static 'images/attachment.svg' %}">
                                    <div class="file-info">
                                        <p>Выбрать файл</p>
                                    </div>
                                {% endif %}
                            </div>
                            {{ form.additional_photo2 }}
                            {% for error in form.additional_photo2.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </label>
                    </div>
                </div>
                
                <!-- Блок материалов -->
                <br>
                <br>
                
                <div class="formset-container">
                    <h2>Материалы</h2>
                    <br>
                    
                    {{ material_formset.management_form }}
                    <div id="materials-formset">
                        {% for form in material_formset %}
                        <div class="formset-item material-form">
                            {{ form.id }}
                            <div class="edit__wrapper">
                                <label>
                                    Материал
                                    {{ form.name }}
                                </label>
                                <label class="delete-label">
                                    Удалить: {{ form.DELETE }}
                                </label>
                            </div>
                            {% for error in form.name.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="formset-footer">
                        <button type="button" id="add-material" class="edit__button">+ Добавить материал</button>
                    </div>
                </div>

                <!-- Блок размеров -->
                <br>
              
                <div class="formset-container">
                    <h2>Размеры</h2>
                    <br>
                    
                    {{ dimension_formset.management_form }}
                    <div id="dimensions-formset">
                        {% for form in dimension_formset %}
                        <div class="formset-item dimension-form">
                            {{ form.id }}
                            <div class="edit__wrapper">
                                <label>
                                    Название
                                    {{ form.name }}
                                </label>
                                <label>
                                    Значение
                                    {{ form.value }}
                                </label>
                                <label class="delete-label">
                                    Удалить: {{ form.DELETE }}
                                </label>
                            </div>
                            {% for error in form.value.errors %}
                                <div class="form-error">{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="formset-footer">
                        <button type="button" id="add-dimension" class="edit__button">+ Добавить размер</button>
                    </div>
                </div>
                
                <div class="edit__wrapper">
                    <button type="submit" class="edit__button">Сохранить изменения</button>
                    <a href="{% url 'product_list' %}" class="edit__button2">Отмена</a>
                </div>
            </form>
        </div>
    </section>
</main>

<script>
    // Функция для создания новой формы материала
    function createMaterialForm(index) {
        const newForm = document.createElement('div');
        newForm.className = 'formset-item material-form';
        newForm.innerHTML = `
            {{ form.id }}
            <div class="edit__wrapper">
                <label>
                    Материал
                    <input type="text" name="materials-${index}-name" id="id_materials-${index}-name" class="form-control">
                </label>
                <label class="delete-label">
                    Удалить: <input type="checkbox" name="materials-${index}-DELETE" id="id_materials-${index}-DELETE">
                </label>
            </div>
            <input type="hidden" name="materials-${index}-id" id="id_materials-${index}-id">
        `;
        return newForm;
    }

    // Функция для создания новой формы размера
    function createDimensionForm(index) {
        const newForm = document.createElement('div');
        newForm.className = 'formset-item dimension-form';
        newForm.innerHTML = `
            {{ form.id }}
             
            <div class="edit__wrapper">
                <label>
                    Название
                    <input type="text" name="dimensions-${index}-name" id="id_dimensions-${index}-name" class="form-control">
                </label>
                <label>
                    Значение
                    <input type="text" name="dimensions-${index}-value" id="id_dimensions-${index}-value" class="form-control">
                </label>
                <label class="delete-label">
                    Удалить: <input type="checkbox" name="dimensions-${index}-DELETE" id="id_dimensions-${index}-DELETE">
                </label>
            </div>
            <input type="hidden" name="dimensions-${index}-id" id="id_dimensions-${index}-id">
        `;
        return newForm;
    }

    // Функция для отображения информации о выбранном файле
    function displayFileInfo(input) {
        const filePreview = input.closest('.edit__file').querySelector('.file-preview');
        const fileInfo = filePreview.querySelector('.file-info');
        
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                filePreview.querySelector('img').src = e.target.result;
                fileInfo.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                `;
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Функция для форматирования размера файла
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Обработчик добавления материала
        document.getElementById('add-material').addEventListener('click', function() {
            const container = document.getElementById('materials-formset');
            const totalForms = document.getElementById('id_materials-TOTAL_FORMS');
            const index = parseInt(totalForms.value);
            
            const newForm = createMaterialForm(index);
            container.appendChild(newForm);
            totalForms.value = index + 1;
            
            // Добавляем обработчик для чекбокса удаления
            const deleteCheckbox = newForm.querySelector(`input[name="materials-${index}-DELETE"]`);
            deleteCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    newForm.style.display = 'none';
                } else {
                    newForm.style.display = 'flex';
                }
            });
        });

        // Обработчик добавления размера
        document.getElementById('add-dimension').addEventListener('click', function() {
            const container = document.getElementById('dimensions-formset');
            const totalForms = document.getElementById('id_dimensions-TOTAL_FORMS');
            const index = parseInt(totalForms.value);
            
            const newForm = createDimensionForm(index);
            container.appendChild(newForm);
            totalForms.value = index + 1;
            
            // Добавляем обработчик для чекбокса удаления
            const deleteCheckbox = newForm.querySelector(`input[name="dimensions-${index}-DELETE"]`);
            deleteCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    newForm.style.display = 'none';
                } else {
                    newForm.style.display = 'flex';
                }
            });
        });

        // Инициализация обработчиков для существующих форм
        document.querySelectorAll('input[name$="-DELETE"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const formItem = this.closest('.formset-item');
                if (this.checked) {
                    formItem.style.display = 'none';
                } else {
                    formItem.style.display = 'flex';
                }
            });
        });

        // Обработчики для отображения информации о выбранных файлах
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', function() {
                displayFileInfo(this);
            });
        });
    });
</script>

<style>
    .formset-container {
        padding: 1.25vw;
    }
    .edit__wrapper input {
        height: 1.3083vw;
    }

    .file-preview {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-info {
        display: flex;
        flex-direction: column;
    }

    .file-name {
        font-size: 14px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }

    .file-size {
        font-size: 12px;
        color: #666;
    }
</style>
{% endblock %}